<!DOCTYPE html>
<html>
<head>
    <title>Real-time Collaborative Task Board</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f8f9fa; }
        h1 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        #task-form { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: white; }
        #taskInput { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        #submitButton { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .task-list { list-style: none; padding: 0; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background-color 0.3s; }
        .task-item.completed { background-color: #e9f8ed; text-decoration: line-through; color: #6c757d; }
        .task-content { flex-grow: 1; display: flex; align-items: center; }
        .task-checkbox { margin-right: 15px; transform: scale(1.5); }
        .task-buttons button { margin-left: 10px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .delete-button { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

    <h1>âœ… Collaborative Task Board</h1>

    <div id="status" style="color: gray; margin-bottom: 15px;">Connecting...</div>

    <div id="task-form">
        <h2>Tambah Tugas Baru</h2>
        <input type="text" id="taskInput" placeholder="Tugas baru atau isu mendesak...">
        <button id="submitButton">Tambah Tugas</button>
    </div>

    <h2>Daftar Tugas</h2>
    <ul class="task-list" id="taskList">
        </ul>

    <script>
        const socket = new WebSocket("ws://localhost:8080/ws");
        const statusDiv = document.getElementById('status');
        const taskList = document.getElementById('taskList');
        const taskInput = document.getElementById('taskInput');
        const submitButton = document.getElementById('submitButton');

        // --- WebSocket Handlers ---

        socket.onopen = function(e) {
            statusDiv.textContent = "Status: Connected.";
            statusDiv.style.color = '#28a745';
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log(`[Message Type] ${data.type}`, data.data);

            switch (data.type) {
                case "INIT_STATE":
                    // Render semua tugas saat koneksi awal
                    renderTasks(data.data);
                    break;
                case "TASK_ADDED":
                    // Tambahkan tugas baru ke DOM
                    addTaskToDOM(data.data, true);
                    break;
                case "TASK_DELETED":
                    // Hapus tugas dari DOM
                    removeTaskFromDOM(data.data);
                    break;
                case "STATUS_UPDATED":
                    // Perbarui status (checklist dan styling)
                    updateTaskStatusInDOM(data.data.id, data.data.status);
                    break;
            }
        };

        socket.onclose = function(event) {
            statusDiv.textContent = "Status: Disconnected. Please refresh.";
            statusDiv.style.color = 'red';
        };

        // --- Business Logic & DOM Manipulation ---

        // Mengirim tugas baru
        function submitNewTask() {
            const text = taskInput.value.trim();
            if (text === "") return;

            const msg = { type: "NEW_TASK", data: text };
            socket.send(JSON.stringify(msg));
            
            taskInput.value = "";
            taskInput.focus();
        }

        // Mengirim permintaan hapus
        function sendDelete(taskId) {
            const msg = { type: "DELETE_TASK", data: taskId };
            socket.send(JSON.stringify(msg));
        }

        // Mengirim permintaan update status
        function sendStatusUpdate(taskId, status) {
            const msg = { type: "UPDATE_STATUS", data: { id: taskId, status: status } };
            socket.send(JSON.stringify(msg));
        }

        // --- DOM RENDER FUNCTIONS ---

        function addTaskToDOM(task) {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.setAttribute('data-id', task.id);
            if (task.status) {
                li.classList.add('completed');
            }

            li.innerHTML = `
                <div class="task-content">
                    <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.status ? 'checked' : ''}>
                    <span class="task-text">${task.text}</span>
                </div>
                <div class="task-buttons">
                    <button class="delete-button" data-id="${task.id}">Hapus</button>
                </div>
            `;
            
            // Attach event listeners
            li.querySelector('.task-checkbox').addEventListener('change', function() {
                sendStatusUpdate(task.id, this.checked);
            });

            li.querySelector('.delete-button').addEventListener('click', function() {
                sendDelete(task.id);
            });

            // Tambahkan di bagian atas (terbaru di atas)
            taskList.prepend(li);
        }

        function renderTasks(tasks) {
            taskList.innerHTML = '';
            // Render dari yang paling baru ke paling lama (karena Go mengurutkan DESC)
            tasks.forEach(task => addTaskToDOM(task));
        }

        function removeTaskFromDOM(taskId) {
            const element = document.querySelector(`.task-item[data-id="${taskId}"]`);
            if (element) {
                element.remove();
            }
        }

        function updateTaskStatusInDOM(taskId, status) {
            const element = document.querySelector(`.task-item[data-id="${taskId}"]`);
            const checkbox = document.querySelector(`.task-checkbox[data-id="${taskId}"]`);
            
            if (element) {
                // Perbarui kelas styling
                if (status) {
                    element.classList.add('completed');
                } else {
                    element.classList.remove('completed');
                }
            }
            if (checkbox) {
                // Perbarui status checkbox
                checkbox.checked = status;
            }
        }

        // Global Event Listeners
        submitButton.addEventListener('click', submitNewTask);
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitNewTask();
            }
        });
    </script>
</body>
</html>